module NetworkProject::RegisterRoot
{
    function onLoad()
    {
        setFadeActor(Username0::bgf);
        setFadeActor(Username1::bgf);
        setFadeActor(Username2::bgf);
        setFadeActor(Password::bgf);
        setFadeActor(Register::bgf);
    }

    function onInitialize(context)
    {
        RegisterRoot.setFocus(Username0::Input::input);
    }

    function onCancel(context)
    {
        var result = openConfirmDialog(context, 1, context.translate(ConnectRoot, "QUIT"));
        if (result)
            start_page(context, LoginRoot);
		
        return EVENTRESULT_FILTER;
    }
}

 
module NetworkProject::RegisterRoot::Register
{
    static uname = nil;
    static pword = nil;

    function search(context, args)
    {
        pword = args[3];

        uname   = nil;
        var success = 0;

        var i = 0;
        while (i < 3)
        {
            uname = args[i];
            if (uname != "")
            {
                if (main::network.adduser(uname, pword))
                {
                    success = 1;
                    break;
                }
                else
                {
                    var error_code = main::network.getLastErrorCode();
                    if (error_code == "error_0_999_0_0_0")
                        break;
                    else
                        break;
                }
            }

            i++;
        }

        return success;
    }

    function onActivate(context)
    {
        main::sound.play("ok");

        var candidate0 = Username0::Input::input.value;
        var candidate1 = Username1::Input::input.value;
        var candidate2 = Username2::Input::input.value;

        if (candidate0 == "" && candidate1 == "" && candidate2 == "")
        {
            openConfirmDialog(context, 0, context.translate(LoginRoot, "NO_NAME"));
            return EVENTRESULT_FILTER;
        }

        var password = Password::Input::input.value;
        if (password == "")
        {
            openConfirmDialog(context, 0, context.translate(LoginRoot, "NO_PASSWORD"));
            return EVENTRESULT_FILTER;
        }

        var args = [candidate0, candidate1, candidate2, password];

        var res = openProcessDialog(
            context,
            context.translate(RegisterRoot, "SEARCH"),
            search,
            args
        );

        if (res)
        {
            main::game.username = uname;
            main::game.password = pword;

            uname = nil;
            pword = nil;

            openConfirmDialog(
                context,
                0,
                context.translate(RegisterRoot, "DONE") + main::game.username
            );

            start_page(context, LoginRoot);
        }
        else
        {
            var error_code = lastProcessError(context);
            openConfirmDialog(context, 0, context.translate(ConnectRoot, error_code));
        }

        return EVENTRESULT_FILTER;
    }
}